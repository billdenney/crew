<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A Distributed Worker Launcher Framework • crew</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="A Distributed Worker Launcher Framework">
<meta property="og:description" content="In computationally demanding analysis projects,
  statisticians and data scientists asynchronously
  deploy long-running tasks to distributed systems,
  ranging from traditional clusters to cloud services.
  The NNG-powered mirai R package by Gao (2023)
  &lt;https://CRAN.R-project.org/package=mirai&gt; is a sleek
  and sophisticated scheduler that
  efficiently processes these intense workloads.
  The crew package extends mirai with a unifying
  interface for third-party worker launchers.
  Inspiration also comes from packages.
  future by Bengtsson (2021) &lt;doi:10.32614/RJ-2021-048&gt;,
  rrq by FitzJohn and Ashton (2023) &lt;https://github.com/mrc-ide/rrq&gt;,
  clustermq by Schubert (2019) &lt;doi:10.1093/bioinformatics/btz284&gt;),
  and batchtools by Lang, Bischel, and Surmann (2017)
  &lt;doi:10.21105/joss.00135&gt;.">
<meta property="og:image" content="/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">crew</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.1.9008</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/controller_groups.html">Controller groups</a>
    </li>
    <li>
      <a href="articles/launcher_plugins.html">Launcher plugins</a>
    </li>
    <li>
      <a href="articles/shiny.html">Asynchronous Shiny apps</a>
    </li>
  </ul>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/wlandau/crew/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">

<div class="section level1">
<div class="page-header"><h1 id="crew-a-distributed-worker-launcher-framework-">crew: a distributed worker launcher framework <img src="reference/figures/logo-readme.png" align="right" height="139"><a class="anchor" aria-label="anchor" href="#crew-a-distributed-worker-launcher-framework-"></a>
</h1></div>
<p><a href="https://CRAN.R-project.org/package=crew" class="external-link"><img src="https://www.r-pkg.org/badges/version/crew" alt="CRAN"></a> <a href="https://www.repostatus.org/#WIP" class="external-link"><img src="https://www.repostatus.org/badges/latest/wip.svg" alt="status"></a> <a href="https://github.com/wlandau/crew/actions?query=workflow%3Acheck" class="external-link"><img src="https://github.com/wlandau/crew/workflows/check/badge.svg" alt="check"></a> <a href="https://app.codecov.io/gh/wlandau/crew" class="external-link"><img src="https://codecov.io/gh/wlandau/crew/branch/main/graph/badge.svg?token=3T5DlLwUVl" alt="codecov"></a> <a href="https://github.com/wlandau/crew/actions?query=workflow%3Alint" class="external-link"><img src="https://github.com/wlandau/crew/workflows/lint/badge.svg" alt="lint"></a></p>
<p>In computationally demanding analysis projects, statisticians and data scientists asynchronously deploy long-running tasks to distributed systems, ranging from traditional clusters to cloud services. The <a href="https://nng.nanomsg.org" class="external-link">NNG</a>-powered <a href="https://github.com/shikokuchuo/mirai" class="external-link"><code>mirai</code></a> R package is a sleek and sophisticated scheduler that efficiently processes these intense workloads. The <code>crew</code> package extends <a href="https://github.com/shikokuchuo/mirai" class="external-link"><code>mirai</code></a> with a unifying interface for third-party worker launchers. Inspiration also comes from packages <a href="https://future.futureverse.org/" class="external-link"><code>future</code></a>, <a href="https://mrc-ide.github.io/rrq/" class="external-link"><code>rrq</code></a>, <a href="https://mschubert.github.io/clustermq/" class="external-link"><code>clustermq</code></a>, and <a href="https://mllg.github.io/batchtools/" class="external-link"><code>batchtools</code></a>.</p>
</div>
<div class="section level1">
<h1 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h1>
<table class="table">
<colgroup>
<col width="13%">
<col width="12%">
<col width="73%">
</colgroup>
<thead><tr class="header">
<th>Type</th>
<th>Source</th>
<th>Command</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Release</td>
<td>CRAN</td>
<td><code>install.packages("crew")</code></td>
</tr>
<tr class="even">
<td>Development</td>
<td>GitHub</td>
<td><code>remotes::install_github("wlandau/crew")</code></td>
</tr>
<tr class="odd">
<td>Development</td>
<td>R-universe</td>
<td><code>install.packages("crew", repos = "https://wlandau.r-universe.dev")</code></td>
</tr>
</tbody>
</table>
</div>
<div class="section level1">
<h1 id="documentation">Documentation<a class="anchor" aria-label="anchor" href="#documentation"></a>
</h1>
<p>Please see <a href="https://wlandau.github.io/crew/" class="external-link uri">https://wlandau.github.io/crew/</a> for documentation, including a full function reference and usage tutorial vignettes.</p>
</div>
<div class="section level1">
<h1 id="plugins">Plugins<a class="anchor" aria-label="anchor" href="#plugins"></a>
</h1>
<p><code>crew</code> lets you write custom <a href="https://wlandau.github.io/crew/reference/crew_class_launcher.html" class="external-link">launchers</a> for different types of workers that connect over the local network. This flexibility can extend <code>crew</code> to platforms like <a href="https://slurm.schedmd.com/" class="external-link">SLURM</a>, <a href="https://en.wikipedia.org/wiki/Oracle_Grid_Engine" class="external-link">SGE</a>, <a href="https://aws.amazon.com/batch/" class="external-link">AWS Batch</a>, and <a href="https://kubernetes.io/" class="external-link">Kubernetes</a>. See the <a href="https://wlandau.github.io/crew/articles/plugins.html" class="external-link">plugin vignette</a> to learn how to create a launcher plugin. The following packages support ready-to-use plugins.</p>
<ul>
<li>
<a href="https://wlandau.github.io/crew.cluster" class="external-link"><code>crew.cluster</code></a>: traditional high-performance computing clusters such as <a href="https://en.wikipedia.org/wiki/Oracle_Grid_Engine" class="external-link">Sun Grid Engine (SGE)</a>.</li>
</ul>
</div>
<div class="section level1">
<h1 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h1>
<p>First, create a controller object. Thanks to the powerful features in <a href="https://github.com/shikokuchuo/mirai" class="external-link"><code>mirai</code></a>, <code><a href="reference/crew_controller_local.html">crew_controller_local()</a></code> allows several ways to customize the way workers are launched and the conditions under which they time out. For example, arguments <code>tasks_max</code> and <code>seconds_idle</code> allow for a smooth continuum between fully persistent workers and fully transient workers.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wlandau.github.io/crew/" class="external-link">crew</a></span><span class="op">)</span></span>
<span><span class="va">controller</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/crew_controller_local.html">crew_controller_local</a></span><span class="op">(</span>seconds_idle <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="https://rdrr.io/r/stats/start.html" class="external-link">start()</a></code> method starts a local <a href="https://github.com/shikokuchuo/mirai" class="external-link"><code>mirai</code></a> client and dispatcher process to listen to workers that dial in into websockets on the local network.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">start</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> method shows metadata on workers and tasks. Use the <code>columns</code> argument to select a subset of columns in the output. The following table has one row per worker, and each column is a summary metric on the popped tasks (tasks which completed and were retrieved with <code>pop()</code>).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"popped_"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 4</span></span>
<span><span class="co">#&gt;   popped_tasks popped_seconds popped_errors popped_warnings</span></span>
<span><span class="co">#&gt;          &lt;int&gt;          &lt;dbl&gt;         &lt;int&gt;           &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1            0              0             0               0</span></span>
<span><span class="co">#&gt; 2            0              0             0               0</span></span></code></pre></div>
<p>Use the <code>push()</code> method to submit a task. When you do, <code>crew</code> automatically scales up the number of workers to meet demand, within the constraints of the <code>auto_scale</code> and <code>workers</code> arguments of <code><a href="reference/crew_controller_local.html">crew_controller_local()</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">push</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"get worker process ID"</span>, command <span class="op">=</span> <span class="fu">ps</span><span class="fu">::</span><span class="fu"><a href="https://ps.r-lib.org/reference/ps_pid.html" class="external-link">ps_pid</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>You can retrieve the results of a completed task, if available, with <code>pop()</code>. Like <code>push()</code>, <code>pop()</code> also tries to launch workers for pending tasks that need them. The return value is <code>NULL</code> if no new tasks are complete.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">pop</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>If you expect a result but see <code>NULL</code>, then <code>mirai</code> may not have assigned the task to a worker yet. This can happen if all workers self-terminate early according to the <code>tasks_max</code> and <code>seconds_idle</code> arguments of <code><a href="reference/crew_controller_local.html">crew_controller_local()</a></code>. Unless you configured the workers to run indefinitely, the controller will need ongoing attention to work through the backlog of tasks. To promptly re-scale workers to meet demand, you can manually repeat calls to <code>pop()</code>, or you can call <code>wait()</code>. The <code>wait()</code> method blocks the R session, repeatedly scales workers, and collects completed tasks.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">wait</span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span></code></pre></div>
<p>When a result is available, <code>pop()</code> will retrieve it.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="va">controller</span><span class="op">$</span><span class="fu">pop</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The result is a <a href="https://en.wikipedia.org/wiki/Monad_(functional_programming)" class="external-link">monad</a> with the result and its metadata. Even if the command of the task throws an error, it will still return the same kind of <a href="https://en.wikipedia.org/wiki/Monad_(functional_programming)" class="external-link">monad</a>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 11</span></span>
<span><span class="co">#&gt;   name         command result seconds   seed error trace warni…¹ launc…² worker insta…³</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;        &lt;chr&gt;   &lt;list&gt;   &lt;dbl&gt;  &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1 get worker … ps::ps… &lt;int&gt;        0 1.56e8 NA    NA    NA      79e71c…      1 7686b2…</span></span>
<span><span class="co">#&gt; # … with abbreviated variable names ¹​warnings, ²​launcher, ³​instance</span></span></code></pre></div>
<p>The return value of the command is available in the <code>result</code> column. In our case, it is the process ID of the parallel worker that ran it, as reported by <code><a href="https://ps.r-lib.org/reference/ps_pid.html" class="external-link">ps::ps_pid()</a></code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out</span><span class="op">$</span><span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="co"># process ID of the parallel worker reported by the task</span></span>
<span><span class="co">#&gt; [1] 69631</span></span></code></pre></div>
<p>Since it ran on a parallel worker, it is different from the process ID of the local R session.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ps</span><span class="fu">::</span><span class="fu"><a href="https://ps.r-lib.org/reference/ps_pid.html" class="external-link">ps_pid</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># local R session process ID</span></span>
<span><span class="co">#&gt; [1] 69523</span></span></code></pre></div>
<p>Continue the above process of asynchronously submitting and collecting tasks until your workflow is complete. You may periodically inspect different columns from the <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> method.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"tasks"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 2</span></span>
<span><span class="co">#&gt;   tasks_assigned tasks_complete</span></span>
<span><span class="co">#&gt;            &lt;int&gt;          &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1              1              1</span></span>
<span><span class="co">#&gt; 2              0              0</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"popped"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 4</span></span>
<span><span class="co">#&gt;   popped_tasks popped_seconds popped_errors popped_warnings</span></span>
<span><span class="co">#&gt;          &lt;int&gt;          &lt;dbl&gt;         &lt;int&gt;           &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1            1              0             0               0</span></span>
<span><span class="co">#&gt; 2            0              0             0               0</span></span></code></pre></div>
<p>When you are done, terminate the controller to close any workers still running, close the <a href="https://github.com/shikokuchuo/mirai" class="external-link"><code>mirai</code></a> dispatcher process, and free the TCP port.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">terminate</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level1">
<h1 id="efficiency-and-resources">Efficiency and resources<a class="anchor" aria-label="anchor" href="#efficiency-and-resources"></a>
</h1>
<p>Adding more workers might speed up your workflow, but not always. Beyond a certain point, the efficiency gains will diminish, and the extra workers will have nothing to do. With proper configuration, you can find the right balance.</p>
<p>As mentioned above, the <code>push()</code>, <code>pop()</code>, and <code>wait()</code> methods of the controller launch new workers automatically in response to changing demand. By default, these workers stay running until <code>controller$terminate()</code>. However, you can customize the controller to scale down when circumstances allow, which helps help avoid wasting resources<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> The most useful arguments for down-scaling, in order of importance, are:</p>
<ol style="list-style-type: decimal">
<li>
<code>seconds_idle</code>: automatically shut down a worker if it spends too long waiting for a target.</li>
<li>
<code>tasks_max</code>: maximum number of tasks a worker can run before shutting down.</li>
<li>
<code>seconds_wall</code>: soft wall time of a worker.</li>
</ol>
<p>On the other hand, it is not always helpful to eagerly down-scale workers. Because the workload can fluctuate rapidly, some workers may quit and relaunch so often that it creates noticeable overhead.</p>
<p>Fortunately, you can investigate auto-scaling and configuration issues empirically. Simply run your workflow and then look at the output from <code>controller$summary()</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/crew_controller_local.html">crew_controller_local</a></span><span class="op">(</span>workers <span class="op">=</span> <span class="fl">10</span>, seconds_idle <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">controller</span><span class="op">$</span><span class="fu">start</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">index</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">controller</span><span class="op">$</span><span class="fu">push</span><span class="op">(</span>command <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">controller</span><span class="op">$</span><span class="fu">wait</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="st">"start collecting results"</span></span>
<span><span class="kw">while</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="va">controller</span><span class="op">$</span><span class="fu">pop</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">controller</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">contains</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"worker_index"</span>, <span class="st">"worker_launches"</span>, <span class="st">"popped_tasks"</span>, <span class="st">"popped_seconds"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 10 × 4</span></span>
<span><span class="co">#&gt;    worker_index worker_launches popped_tasks popped_seconds</span></span>
<span><span class="co">#&gt;           &lt;int&gt;           &lt;int&gt;        &lt;int&gt;          &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1            1               1          236          0.005</span></span>
<span><span class="co">#&gt;  2            2               1          110          0.004</span></span>
<span><span class="co">#&gt;  3            3               1           96          0.001</span></span>
<span><span class="co">#&gt;  4            4               1           81          0.005</span></span>
<span><span class="co">#&gt;  5            5               1           89          0.002</span></span>
<span><span class="co">#&gt;  6            6               1           77          0.003</span></span>
<span><span class="co">#&gt;  7            7               1           78          0.005</span></span>
<span><span class="co">#&gt;  8            8               1           75          0.001</span></span>
<span><span class="co">#&gt;  9            9               1           78          0.008</span></span>
<span><span class="co">#&gt; 10           10               1           80          0.002</span></span></code></pre></div>
<p>Each worker only launched once and moved through tasks quickly, which is a good sign for a batch of 1000 instantaneous independent tasks. However, the first worker completed many more tasks than the others, even though all workers should share the load equally in this particular case. It would be helpful to see if the same workload runs just as fast with fewer workers.</p>
</div>
<div class="section level1">
<h1 id="risks">Risks<a class="anchor" aria-label="anchor" href="#risks"></a>
</h1>
<p>The <code>crew</code> package has unavoidable risk. It is your responsibility as the user to safely use <code>crew</code>. Please read the final clause of the <a href="https://wlandau.github.io/crew/LICENSE.html" class="external-link">software license</a>.</p>
<div class="section level3">
<h3 id="bugs">Bugs<a class="anchor" aria-label="anchor" href="#bugs"></a>
</h3>
<p><code>crew</code> is experimental new software, and it has known bugs such as <a href="https://github.com/wlandau/crew/issues/75" class="external-link uri">https://github.com/wlandau/crew/issues/75</a>. Use at your own risk. Please report bugs to <a href="https://github.com/wlandau/crew/issues" class="external-link uri">https://github.com/wlandau/crew/issues</a>.</p>
</div>
<div class="section level3">
<h3 id="security">Security<a class="anchor" aria-label="anchor" href="#security"></a>
</h3>
<p><code>crew</code> currently uses unencrypted TCP connections for transactions with workers inside a trusted local network. In a compromised network, an attacker can potentially access and exploit sensitive resources. It is your responsibility to assess the sensitivity and vulnerabilities of your computing environment and make sure your network is secure.</p>
</div>
<div class="section level3">
<h3 id="ports">Ports<a class="anchor" aria-label="anchor" href="#ports"></a>
</h3>
<p><code>crew</code> uses one TCP port per controller. TCP ports range from 0 to 65535, and only around 16000 of these ports are considered ephemeral or dynamic, so please be careful not to run too many controllers simultaneously if you are running R on a machine you share with other people (such as the login node of a computing cluster). If you are running a <a href="https://wlandau.github.io/crew/articles/controller_groups.html" class="external-link">controller group</a> please add only a small number of controllers to the group. The <code>terminate()</code> method of the controller and <code>crew_session_terminate()</code> should free these ports again for other processes to use.</p>
</div>
<div class="section level3">
<h3 id="zombies">Zombies<a class="anchor" aria-label="anchor" href="#zombies"></a>
</h3>
<p>The <code>crew</code> package launches external R processes:</p>
<ol style="list-style-type: decimal">
<li>Worker processes to run tasks, possibly on different computers on the local network, and</li>
<li>A local <a href="https://github.com/shikokuchuo/mirai" class="external-link"><code>mirai</code></a> dispatcher process to schedule the tasks.</li>
</ol>
<p>To the best of its ability, <code>crew</code> tries to only launch the processes it needs, and it relies on <code>mirai</code> to clean up these processes when the work is done. However, sometimes it is still possible that too many workers may run concurrently, and it is still possible that either the workers or the <a href="https://github.com/shikokuchuo/mirai" class="external-link"><code>mirai</code></a> dispatcher may run too long or hang. In large-scale workflows, these accidents can have egregious consequences. Depending on the launcher type, these consequences can range from overburdening your local machine or cluster, to incurring unexpectedly high costs on <a href="https://aws.amazon.com/" class="external-link">Amazon Web Services</a>.</p>
</div>
<div class="section level3">
<h3 id="workers">Workers<a class="anchor" aria-label="anchor" href="#workers"></a>
</h3>
<p><code>mirai</code> robustly terminates workers as appropriate, but this safeguard cannot protect against the risk of a worker that gets stuck in a crashed state before it can even start R. To be absolutely sure that workers do not run indefinitely if something goes wrong, please learn how to find and terminate workers on the specific computing platform where they run. And if you are writing a custom launcher plugin, it is recommended (although not strictly required) to write a custom <code>terminate_worker()</code> method.</p>
<p>Workers may run on different computing platforms, depending on the type of launcher you choose. Each type of launcher connects to a different computing platform, and each platform has a different way of terminating workers. For example, the <a href="https://wlandau.github.io/crew/reference/crew_launcher_local.html" class="external-link">local process launcher</a> creates R processes on your local machine, which you can find and terminate with <a href="https://ps.r-lib.org/reference/ps.html" class="external-link"><code>ps::ps()</code></a>/<a href="https://ps.r-lib.org/reference/ps_kill.html" class="external-link"><code>ps::ps_kill()</code></a> or <a href="https://htop.dev/" class="external-link"><code>htop</code></a>. For a SLURM launcher, you need <a href="https://slurm.schedmd.com/squeue.html" class="external-link"><code>squeue</code></a> to find workers and <a href="https://slurm.schedmd.com/scancel.html" class="external-link"><code>scancel</code></a> to terminate them. For an <a href="https://aws.amazon.com/" class="external-link">Amazon Web Services</a> launcher, please use the <a href="https://aws.amazon.com/console/" class="external-link">AWS web console</a> or <a href="https://aws.amazon.com/cloudwatch/" class="external-link">CloudWatch</a>.</p>
</div>
<div class="section level3">
<h3 id="scheduling">Scheduling<a class="anchor" aria-label="anchor" href="#scheduling"></a>
</h3>
<p>Depending on user settings, <code>crew</code> workers may run for the entire length of the analysis pipeline, or they may exit if they idle too long or complete a certain number of tasks. <code>crew</code> re-launches workers if there are more unfinished tasks in the queue than <a href="https://wlandau.github.io/crew/reference/crew_class_launcher.html#details" class="external-link">active workers</a> to run them at a given snapshot in time. This kind of auto-scaling does not dedicate any specific worker to any specific task, and it does not perform well when workers exit too quickly due to a small value of <code>seconds_idle</code>. Please set <code>seconds_idle</code> to a generous enough value for workers to accept work, and please use <code>tasks_max</code> to specify short-lived workers such as single-task transient workers (<code>tasks_max = 1</code>).</p>
</div>
<div class="section level3">
<h3 id="dispatcher">Dispatcher<a class="anchor" aria-label="anchor" href="#dispatcher"></a>
</h3>
<p>The <a href="https://github.com/shikokuchuo/mirai" class="external-link"><code>mirai</code></a> dispatcher is designed to gracefully exit when you call <code>terminate()</code> on the controller object or when you restart your R session. However, if you ever need to shut down the dispatcher manually, you can find the process ID using the controller object, then use <code><a href="https://ps.r-lib.org/reference/ps_kill.html" class="external-link">ps::ps_kill()</a></code> to terminate the process.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="va">router</span><span class="op">$</span><span class="va">dispatcher</span></span>
<span><span class="co">#&gt; [1] 86028</span></span>
<span><span class="va">handle</span> <span class="op">&lt;-</span> <span class="fu">ps</span><span class="fu">::</span><span class="fu"><a href="https://ps.r-lib.org/reference/ps_handle.html" class="external-link">ps_handle</a></span><span class="op">(</span>pid <span class="op">=</span> <span class="fl">86028L</span><span class="op">)</span></span>
<span><span class="fu">ps</span><span class="fu">::</span><span class="fu"><a href="https://ps.r-lib.org/reference/ps_is_running.html" class="external-link">ps_is_running</a></span><span class="op">(</span><span class="va">handle</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu">ps</span><span class="fu">::</span><span class="fu"><a href="https://ps.r-lib.org/reference/ps_kill.html" class="external-link">ps_kill</a></span><span class="op">(</span><span class="va">handle</span><span class="op">)</span></span>
<span><span class="fu">ps</span><span class="fu">::</span><span class="fu"><a href="https://ps.r-lib.org/reference/ps_is_running.html" class="external-link">ps_is_running</a></span><span class="op">(</span><span class="va">handle</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
</div>
</div>
<div class="section level1">
<h1 id="similar-work">Similar work<a class="anchor" aria-label="anchor" href="#similar-work"></a>
</h1>
<ul>
<li>
<a href="https://github.com/shikokuchuo/mirai" class="external-link"><code>mirai</code></a>: a powerful R framework for asynchronous tasks built on <a href="https://nng.nanomsg.org" class="external-link">NNG</a>. The purpose of <code>crew</code> is to extend <a href="https://github.com/shikokuchuo/mirai" class="external-link"><code>mirai</code></a> to different computing platforms for distributed workers.</li>
<li>
<a href="https://mrc-ide.github.io/rrq/" class="external-link"><code>rrq</code></a>: a task queue for R based on <a href="https://redis.io" class="external-link">Redis</a>.</li>
<li>
<a href="http://traitecoevo.github.io/rrqueue/" class="external-link"><code>rrqueue</code></a>: predecessor of <a href="https://mrc-ide.github.io/rrq/" class="external-link"><code>rrq</code></a>.</li>
<li>
<a href="https://mschubert.github.io/clustermq/" class="external-link"><code>clustermq</code></a>: sends R function calls as jobs to computing clusters.</li>
<li>
<a href="https://future.futureverse.org/" class="external-link"><code>future</code></a>: a unified interface for asynchronous evaluation of single tasks and map-reduce calls on a wide variety of backend technologies.</li>
<li>
<a href="https://mllg.github.io/batchtools/" class="external-link"><code>batchtools</code></a>: tools for computation on batch systems.</li>
<li>
<a href="https://docs.ropensci.org/targets/" class="external-link"><code>targets</code></a>: a Make-like pipeline tool for R.</li>
<li>
<a href="https://r-lib.github.io/later/" class="external-link"><code>later</code></a>: delayed evaluation of synchronous tasks.</li>
<li>
<a href="https://rstudio.github.io/promises/" class="external-link"><code>promises</code></a>: minimally-invasive asynchronous programming for a small number of tasks within Shiny apps.</li>
<li>
<a href="https://github.com/r-lib/callr" class="external-link"><code>callr</code></a>: initiates R process from other R processes.</li>
<li>
<a href="https://CRAN.R-project.org/view=HighPerformanceComputing" class="external-link">High-performance computing CRAN task view</a>.</li>
</ul>
</div>
<div class="section level1">
<h1 id="thanks">Thanks<a class="anchor" aria-label="anchor" href="#thanks"></a>
</h1>
<p>The <code>crew</code> package incorporates insightful ideas from the following people.</p>
<ul>
<li>
<a href="https://github.com/shikokuchuo" class="external-link">Charlie Gao</a> created <a href="https://github.com/shikokuchuo/mirai" class="external-link"><code>mirai</code></a> and <a href="https://github.com/shikokuchuo/nanonext" class="external-link"><code>nanonext</code></a> and graciously accommodated the complicated and demanding feature requests that made <code>crew</code> possible.</li>
<li>
<a href="https://github.com/richfitz" class="external-link">Rich FitzJohn</a> and <a href="https://github.com/r-ash" class="external-link">Robert Ashton</a> developed <a href="https://mrc-ide.github.io/rrq//" class="external-link"><code>rrq</code></a>.</li>
<li>
<a href="https://github.com/gaborcsardi/" class="external-link">Gábor Csárdi</a> developed <a href="https://github.com/r-lib/callr" class="external-link"><code>callr</code></a> and wrote an <a href="https://www.tidyverse.org/blog/2019/09/callr-task-q/" class="external-link">edifying blog post on implementing task queues</a>.</li>
<li>
<a href="https://github.com/krlmlr/" class="external-link">Kirill Müller</a> created the <a href="https://github.com/wlandau/workers" class="external-link"><code>workers</code></a> prototype, an initial effort that led directly to the current implementation of <code>crew</code>. <code>crew</code> would not exist without Kirill’s insights about orchestration models for R processes.</li>
<li>
<a href="https://github.com/HenrikBengtsson/" class="external-link">Henrik Bengtsson</a>. Henrik’s <a href="https://github.com/HenrikBengtsson/future/" class="external-link"><code>future</code></a> package ecosystem demonstrates the incredible power of a consistent R interface on top of a varying collection of high-performance computing technologies.</li>
<li>
<a href="https://github.com/mschubert/" class="external-link">Michael Schubert</a>. Michael’s <a href="https://mschubert.github.io/clustermq/" class="external-link"><code>clustermq</code></a> package supports efficient high-performance computing on traditional clusters, and it demonstrates the value of a central <code>R6</code> object to manage an entire collection of persistent workers.</li>
<li>
<a href="https://github.com/davidkretch" class="external-link">David Kretch</a>. The <a href="https://github.com/paws-r/paws" class="external-link"><code>paws</code></a> R package is a powerful interface to Amazon Web Services, and the documentation clearly communicates the capabilities and limitations of AWS to R users.</li>
<li>
<a href="https://github.com/adambanker" class="external-link">Adam Banker</a>, co-authored <a href="https://github.com/paws-r/paws" class="external-link"><code>paws</code></a> with <a href="https://github.com/davidkretch" class="external-link">David Kretch</a>.</li>
<li>
<a href="https://github.com/mdneuzerling" class="external-link">David Neuzerling</a>. David’s <a href="https://github.com/mdneuzerling/lambdr/" class="external-link"><code>lambdr</code></a> package establishes a helpful pattern to submit and collect AWS Lambda jobs from R.</li>
<li>
<a href="https://github.com/MarkEdmondson1234/" class="external-link">Mark Edmondson</a>. Mark maintains several R packages to interface with Google Cloud Platform such as <a href="https://github.com/cloudyr/googleCloudStorageR" class="external-link"><code>googleCloudStorageR</code></a> and <a href="https://github.com/MarkEdmondson1234/googleCloudRunner" class="external-link"><code>googleCloudRunner</code></a>, and he <a href="https://github.com/ropensci/targets/issues/720" class="external-link">started the conversation</a> around helping <a href="https://github.com/ropensci/targets" class="external-link"><code>targets</code></a> submit jobs to Google Cloud Run.</li>
</ul>
</div>
<div class="section level1">
<h1 id="code-of-conduct">Code of Conduct<a class="anchor" aria-label="anchor" href="#code-of-conduct"></a>
</h1>
<p>Please note that the <code>crew</code> project is released with a <a href="https://github.com/wlandau/crew/blob/main/CODE_OF_CONDUCT.md" class="external-link">Contributor Code of Conduct</a>. By contributing to this project, you agree to abide by its terms.</p>
</div>
<div class="section level1">
<h1 id="citation">Citation<a class="anchor" aria-label="anchor" href="#citation"></a>
</h1>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/citation.html" class="external-link">citation</a></span><span class="op">(</span><span class="st">"crew"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="footnotes footnotes-end-of-document">
<hr>
<ol>
<li id="fn1"><p>Automatic down-scaling also helps comply with wall time restrictions on shared computing clusters. See the arguments of <a href="https://wlandau.github.io/crew/reference/crew_controller_local.html" class="external-link"><code>crew_controller_local()</code></a> for details.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=crew" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/wlandau/crew/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/wlandau/crew/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>

<div class="community">
<h2 data-toc-skip>Community</h2>
<ul class="list-unstyled">
<li><a href="CONTRIBUTING.html">Contributing guide</a></li>
<li><a href="CODE_OF_CONDUCT.html">Code of conduct</a></li>
</ul>
</div>

<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing crew</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>William Michael Landau <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0003-1878-3253" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li><a href="authors.html">More about authors...</a></li>
</ul>
</div>



  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by William Michael Landau.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
